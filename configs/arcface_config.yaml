# Config ArcFace Fine-tune - Phase 2
# Resume tu epoch 49 (val_acc 80.33%) - Giam overfitting, tang val_acc len 82-83%

# Model Architecture
model:
  backbone: resnet50
  embedding_size: 512
  pretrained: true
  freeze_ratio: 0.0 # KHONG dong bang - can train full backbone

# ArcFace Loss - TANG MARGIN DE KHAT KHAO HON
arcface:
  margin: 0.2 # Tang tu 0.1 len 0.2 - khat khao hon, giam overfit
  scale: 64.0 # Giu nguyen - da hoat dong tot
  easy_margin: false # TAT de khat khao hon

# Training Configuration - Fine-tune phase
training:
  num_epochs: 100 # Them 30 epochs nua (tu epoch 50)
  batch_size: 128
  num_workers: 4

  warmup:
    enabled: false # TAT warmup khi resume

  optimizer:
    type: sgd
    lr: 0.01 # Giam tu 0.1, bat dau fine-tune voi LR thap hon
    momentum: 0.9
    weight_decay: 0.001 # TANG TU 0.0005 - regularization manh hon

  scheduler:
    type: step
    step_size: 10 # Giam LR moi 10 epochs
    gamma: 0.1 # LR: 0.01 -> 0.001 (epoch 10) -> 0.0001 (epoch 20)
    eta_min: 0.00001

  grad_clip:
    enabled: true
    max_norm: 5.0

  early_stopping:
    enabled: true
    patience: 10 # Giam patience trong fine-tune phase
    min_delta: 0.001 # Tang threshold de chi stop khi that su khong cai thien

  # LABEL SMOOTHING - GIAM OVERCONFIDENCE
  label_smoothing: 0.05 # Them label smoothing nhe

# Data Configuration
data:
  mode: folder # Khong can CSV metadata

  # Paths (se bi override boi --data_dir)
  train_data_root: data/train
  val_data_root: data/val

  # CSV paths (chi dung khi mode: csv)
  train_csv: data/metadata/train_labels.csv
  val_csv: data/metadata/val_labels.csv

  min_images_per_identity: 5
  class_balanced_sampling: true
  augment_strength: heavy # TANG augmentation de giam overfit
  image_size: 112

  normalize:
    mean: [0.5, 0.5, 0.5]
    std: [0.5, 0.5, 0.5]

# Checkpointing
checkpoint:
  save_dir: /kaggle/working/checkpoints/arcface
  save_best: true
  save_interval: 1
  keep_last_n: 2 # Giam de tiet kiem dung luong

# Logging
logging:
  use_tensorboard: false # Tat TensorBoard tren Kaggle
  log_dir: /kaggle/working/logs/arcface
  log_interval: 50

  embedding_vis:
    enabled: false # Tat t-SNE de tiet kiem thoi gian

# Device
device: cuda

# Mixed Precision - bat de tang toc
mixed_precision:
  enabled: true
