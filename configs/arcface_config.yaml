# Cau hinh ArcFace Training
# Ho tro: Early Stopping + Learning Rate Scheduling

# Model Architecture
model:
  backbone: resnet50
  embedding_size: 512
  pretrained: true
  freeze_ratio: 0.8  # Dong bang 80% lop dau cua backbone

# ArcFace Loss
arcface:
  margin: 0.35  # m parameter - giam tu 0.5 de de hoi tu hon voi nhieu classes
  scale: 30.0   # s parameter - giam tu 64 de gradients on dinh hon
  easy_margin: false

# Training Configuration
training:
  num_epochs: 50
  batch_size: 256
  num_workers: 8
  
  # Warmup (quan trong cho ArcFace voi nhieu classes)
  warmup:
    enabled: true
    epochs: 5           # So epochs warmup
    start_lr: 0.0004    # LR bat dau (tang theo batch size)
  
  # Warmup (quan trong cho ArcFace voi nhieu classes)
  warmup:
    enabled: true
    epochs: 5           # So epochs warmup
    start_lr: 0.0001    # LR bat dau
  
  # Optimizer: sgd, adam, adamw
  optimizer:
    type: sgd
<<<<<<< HEAD
    lr: 0.001           # Giam tu 0.01 xuong 0.001
=======
    lr: 0.004           # Tang theo linear scaling (batch 256/64 = 4x)
>>>>>>> a10b4250691c6ef0bbc40ff67c8d2b951775aabf
    momentum: 0.9
    weight_decay: 0.0005
  
  # Learning Rate Scheduler
  # Options: step, cosine, plateau
  scheduler:
    type: cosine        # Cosine tot hon cho ArcFace
    # StepLR params
    step_size: 10       # Giam LR moi step_size epochs
    gamma: 0.1          # Nhan LR voi gamma
    # CosineAnnealingLR params
    eta_min: 0.00001    # LR toi thieu
    # ReduceLROnPlateau params (type: plateau)
    # mode: min       # min cho loss, max cho accuracy
    # factor: 0.1     # Nhan LR voi factor khi khong cai thien
    # patience: 5     # So epochs cho phep khong cai thien truoc khi giam LR
    # min_lr: 0.0000001
  
  # Gradient Clipping
  grad_clip:
    enabled: true
    max_norm: 5.0
  
  # Early Stopping
  early_stopping:
    enabled: true
    patience: 10      # Dung sau patience epochs khong cai thien
    min_delta: 0.001  # Nguong toi thieu de coi la "cai thien"

# Data Configuration
data:
  # Paths (local)
  train_csv: data/CelebA_Aligned/metadata/train_labels_filtered.csv
  val_csv: data/CelebA_Aligned/metadata/val_labels_filtered.csv
  train_data_root: data/CelebA_Aligned/train
  val_data_root: data/CelebA_Aligned/val
  
  # Image settings
  image_size: 112
  
  # Augmentation
  augmentation:
    horizontal_flip: 0.5
    rotation_degrees: 10
    color_jitter:
      brightness: 0.2
      contrast: 0.2
      saturation: 0.1
      hue: 0.05
  
  # Normalization
  normalize:
    mean: [0.5, 0.5, 0.5]
    std: [0.5, 0.5, 0.5]

# Checkpointing
checkpoint:
  save_dir: models/checkpoints/arcface
  save_best: true
  save_interval: 1       # Luu moi epoch (quan trong cho Colab 12h limit)
  keep_last_n: 3         # Chi giu 3 checkpoints gan nhat de tiet kiem dung luong

# Logging
logging:
  use_tensorboard: true
  log_dir: logs/arcface
  log_interval: 100
  
  embedding_vis:
    enabled: true
    interval: 5
    num_samples: 1000

# Device
device: cuda

# Mixed Precision Training (FP16) - tang toc 2-3x tren GPU
mixed_precision:
  enabled: true         # Bat FP16 de tang toc training
  opt_level: "O1"       # O1: mixed, O2: almost FP16
