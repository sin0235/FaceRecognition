{% extends "base.html" %} {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/style.css') }}"
/>

<style>
  .db-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .db-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .db-header h2 {
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    letter-spacing: -0.5px;
  }

  .db-header .subtitle {
    font-size: 15px;
    color: var(--muted);
    font-weight: 500;
  }

  .model-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
  }

  .model-tab {
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    background: none;
    border: none;
    cursor: pointer;
    position: relative;
    transition: all 0.3s;
    font-family: "Plus Jakarta Sans", "Inter", system-ui, sans-serif;
  }

  .model-tab:hover {
    color: var(--primary);
  }

  .model-tab.active {
    color: var(--primary);
  }

  .model-tab.active::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary);
  }

  .form-section {
    display: none;
  }

  .form-section.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
    font-size: 14px;
  }

  .form-group input[type="text"],
  .form-group input[type="number"],
  .form-group select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: "Plus Jakarta Sans", "Inter", system-ui, sans-serif;
    transition: all 0.2s;
    background: white;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(37, 99, 235, 0.02);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-top: 8px;
  }

  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .help-text {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  .file-input-group {
    position: relative;
  }

  .file-input-display {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .file-input-display:hover {
    border-color: var(--primary);
    background: rgba(37, 99, 235, 0.02);
  }

  .file-input-display .btn-secondary {
    margin-left: 8px;
    padding: 6px 16px;
    font-size: 12px;
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--border);
  }

  .advanced-options {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 2px solid var(--border);
  }

  .collapse-toggle {
    background: none;
    border: none;
    color: var(--primary);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 16px;
    font-size: 14px;
    font-family: "Plus Jakarta Sans", "Inter", system-ui, sans-serif;
  }

  .collapse-toggle:hover {
    text-decoration: underline;
  }

  .collapse-content {
    display: none;
  }

  .collapse-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  .progress-section {
    display: none;
    margin-top: 32px;
  }

  .progress-section.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .progress-header h3 {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }

  .progress-status {
    font-size: 13px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 6px;
  }

  .progress-status.running {
    background: rgba(37, 99, 235, 0.1);
    color: var(--primary);
  }

  .progress-status.completed {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
  }

  .progress-status.failed {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
  }

  .progress-bar-container {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .progress-bar {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s;
  }

  .progress-message {
    color: var(--muted);
    margin-bottom: 16px;
    font-size: 13px;
  }

  .log-container {
    background: #1e293b;
    color: #e2e8f0;
    padding: 16px;
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
    font-family: "Courier New", monospace;
    font-size: 12px;
    line-height: 1.5;
  }

  .log-line {
    margin-bottom: 4px;
  }

  .output-files {
    margin-top: 24px;
  }

  .output-file {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: rgba(37, 99, 235, 0.03);
    border: 1px solid rgba(37, 99, 235, 0.1);
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 13px;
    transition: all 0.2s;
  }

  .output-file:hover {
    background: rgba(37, 99, 235, 0.05);
    border-color: rgba(37, 99, 235, 0.2);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.08);
  }

  .btn-download {
    padding: 6px 16px;
    background: var(--success);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s;
  }

  .btn-download:hover {
    background: #059669;
  }
</style>

<div class="card">
  <div class="db-container">
    <div class="db-header">
      <h2>Database Builder</h2>
      <p class="subtitle">
        Tạo database embeddings cho ArcFace, FaceNet và LBPH model
      </p>
    </div>

    <div class="model-tabs">
      <button class="model-tab active" data-model="arcface">ArcFace</button>
      <button class="model-tab" data-model="facenet">FaceNet</button>
      <button class="model-tab" data-model="lbph">LBPH</button>
    </div>

    <!-- ArcFace Form -->
    <div class="form-section active" id="arcface-form">
      <h3 class="section-title">Cấu hình ArcFace Database</h3>

      <div class="form-group">
        <label>Model Checkpoint</label>
        <select id="arcface-model">
          <option value="">-- Chọn checkpoint --</option>
          {% for model in arcface_models %}
          <option value="{{ model }}">{{ model }}</option>
          {% endfor %}
        </select>
        <div class="help-text">
          Chọn trained ArcFace model checkpoint (.pth)
        </div>
      </div>

      <div class="form-group">
        <label>Dataset Directory</label>
        <div class="file-input-group">
          <div
            class="file-input-display"
            onclick="selectDirectory('arcface-dataset-input')"
          >
            <span id="arcface-dataset-display">Chưa chọn dataset...</span>
            <button class="btn-secondary" type="button">Browse</button>
          </div>
          <input
            type="file"
            id="arcface-dataset-input"
            webkitdirectory
            directory
            style="display: none"
          />
        </div>
        <div class="help-text">
          Chọn thư mục chứa các folder identity (identity/images)
        </div>
      </div>

      <div class="form-group">
        <label>Output Filename</label>
        <input
          type="text"
          id="arcface-output"
          value="arcface_embeddings_db.npy"
        />
        <div class="help-text">
          Tên file database output (sẽ lưu trong data/)
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Device</label>
          <select id="arcface-device">
            <option value="cpu">CPU</option>
            <option value="cuda">CUDA (GPU)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="checkbox-group">
            <input type="checkbox" id="arcface-face-detection" checked />
            <span>Sử dụng Face Detection</span>
          </label>
          <div class="help-text">Detect và align face trước khi extract</div>
        </div>
      </div>

      <button
        class="btn"
        style="margin-top: 16px"
        onclick="startBuild('arcface')"
      >
        Bắt đầu Build Database
      </button>
    </div>

    <!-- FaceNet Form -->
    <div class="form-section" id="facenet-form">
      <h3 class="section-title">Cấu hình FaceNet Database</h3>

      <div class="form-group">
        <label>Model Checkpoint</label>
        <select id="facenet-model">
          <option value="">-- Chọn checkpoint --</option>
          {% for model in facenet_models %}
          <option value="{{ model }}">{{ model }}</option>
          {% endfor %}
        </select>
        <div class="help-text">
          Chọn trained FaceNet model checkpoint (.pth)
        </div>
      </div>

      <div class="form-group">
        <label>Dataset Directory</label>
        <div class="file-input-group">
          <div
            class="file-input-display"
            onclick="selectDirectory('facenet-dataset-input')"
          >
            <span id="facenet-dataset-display">Chưa chọn dataset...</span>
            <button class="btn-secondary" type="button">Browse</button>
          </div>
          <input
            type="file"
            id="facenet-dataset-input"
            webkitdirectory
            directory
            style="display: none"
          />
        </div>
        <div class="help-text">Chọn thư mục chứa các folder identity</div>
      </div>

      <div class="form-group">
        <label>Output Filename</label>
        <input
          type="text"
          id="facenet-output"
          value="facenet_embeddings_db.npy"
        />
        <div class="help-text">Tên file database output</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Device</label>
          <select id="facenet-device">
            <option value="cpu">CPU</option>
            <option value="cuda">CUDA (GPU)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="checkbox-group">
            <input type="checkbox" id="facenet-face-detection" checked />
            <span>Sử dụng Face Detection</span>
          </label>
          <div class="help-text">Detect và crop face (160x160)</div>
        </div>
      </div>

      <button
        class="btn"
        style="margin-top: 16px"
        onclick="startBuild('facenet')"
      >
        Bắt đầu Build Database
      </button>
    </div>

    <!-- LBPH Form -->
    <div class="form-section" id="lbph-form">
      <h3 class="section-title">Cấu hình LBPH Model Training</h3>

      <div class="form-group">
        <label>Dataset Directory (Train)</label>
        <div class="file-input-group">
          <div
            class="file-input-display"
            onclick="selectDirectory('lbph-dataset-input')"
          >
            <span id="lbph-dataset-display">Chưa chọn dataset...</span>
            <button class="btn-secondary" type="button">Browse</button>
          </div>
          <input
            type="file"
            id="lbph-dataset-input"
            webkitdirectory
            directory
            style="display: none"
          />
        </div>
        <div class="help-text">Chọn thư mục train chứa các folder identity</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Output Directory</label>
          <input
            type="text"
            id="lbph-output-dir"
            value="models/checkpoints/LBHP"
          />
        </div>

        <div class="form-group">
          <label>Model Filename</label>
          <input type="text" id="lbph-model-name" value="lbph_model.xml" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Target Width</label>
          <input type="number" id="lbph-width" value="100" min="32" />
        </div>

        <div class="form-group">
          <label>Target Height</label>
          <input type="number" id="lbph-height" value="100" min="32" />
        </div>
      </div>

      <div class="form-group">
        <label class="checkbox-group">
          <input type="checkbox" id="lbph-face-detection" checked />
          <span>Sử dụng Face Detection</span>
        </label>
        <div class="help-text">Detect và crop face trước khi train</div>
      </div>

      <div class="advanced-options">
        <button
          class="collapse-toggle"
          onclick="toggleCollapse('lbph-advanced')"
        >
          ⚙️ Tùy chọn nâng cao
        </button>

        <div class="collapse-content" id="lbph-advanced">
          <div class="form-row">
            <div class="form-group">
              <label>Radius</label>
              <input type="number" id="lbph-radius" value="1" min="1" />
              <div class="help-text">Bán kính LBP operator</div>
            </div>

            <div class="form-group">
              <label>Neighbors</label>
              <input type="number" id="lbph-neighbors" value="8" min="4" />
              <div class="help-text">Số neighbors LBP operator</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Grid X</label>
              <input type="number" id="lbph-grid-x" value="8" min="1" />
              <div class="help-text">Số cells theo chiều ngang</div>
            </div>

            <div class="form-group">
              <label>Grid Y</label>
              <input type="number" id="lbph-grid-y" value="8" min="1" />
              <div class="help-text">Số cells theo chiều dọc</div>
            </div>
          </div>

          <div class="form-group">
            <label class="checkbox-group">
              <input type="checkbox" id="lbph-find-threshold" />
              <span>Tìm threshold tối ưu</span>
            </label>
            <div class="help-text">
              Sử dụng validation set để tìm threshold tốt nhất
            </div>
          </div>

          <div class="form-group" id="lbph-val-group" style="display: none">
            <label>Validation Dataset Directory</label>
            <div class="file-input-group">
              <div
                class="file-input-display"
                onclick="selectDirectory('lbph-val-dataset-input')"
              >
                <span id="lbph-val-dataset-display"
                  >Chưa chọn validation dataset...</span
                >
                <button class="btn-secondary" type="button">Browse</button>
              </div>
              <input
                type="file"
                id="lbph-val-dataset-input"
                webkitdirectory
                directory
                style="display: none"
              />
            </div>
          </div>
        </div>
      </div>

      <button class="btn" style="margin-top: 16px" onclick="startBuild('lbph')">
        Bắt đầu Train Model
      </button>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progress-section">
      <div class="result-box">
        <div class="progress-header">
          <h3>Build Progress</h3>
          <span class="progress-status" id="progress-status">Running</span>
        </div>

        <div class="progress-bar-container">
          <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>

        <div class="progress-message" id="progress-message">
          Đang khởi tạo...
        </div>

        <h4
          style="
            margin-top: 20px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
          "
        >
          Logs
        </h4>
        <div class="log-container" id="log-container">
          <div class="log-line">Waiting for logs...</div>
        </div>

        <div class="output-files" id="output-files" style="display: none">
          <h4 style="margin-bottom: 12px; font-size: 14px; font-weight: 600">
            Output Files
          </h4>
          <div id="output-files-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Model tab switching
  document.querySelectorAll(".model-tab").forEach((tab) => {
    tab.addEventListener("click", () => {
      const model = tab.dataset.model;

      document
        .querySelectorAll(".model-tab")
        .forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");

      document
        .querySelectorAll(".form-section")
        .forEach((s) => s.classList.remove("active"));
      document.getElementById(`${model}-form`).classList.add("active");
    });
  });

  // Directory selection
  function selectDirectory(inputId) {
    document.getElementById(inputId).click();
  }

  // Handle directory selection
  document.querySelectorAll("input[webkitdirectory]").forEach((input) => {
    input.addEventListener("change", (e) => {
      const files = e.target.files;
      if (files.length > 0) {
        const path = files[0].webkitRelativePath.split("/")[0];
        const displayId = input.id.replace("-input", "-display");
        document.getElementById(displayId).textContent = path;

        // Store full path
        input.dataset.selectedPath = files[0].path
          ? files[0].path.split(path)[0] + path
          : path;
      }
    });
  });

  // LBPH threshold toggle
  document
    .getElementById("lbph-find-threshold")
    .addEventListener("change", (e) => {
      document.getElementById("lbph-val-group").style.display = e.target.checked
        ? "block"
        : "none";
    });

  function toggleCollapse(id) {
    document.getElementById(id).classList.toggle("active");
  }

  let currentJobId = null;
  let pollInterval = null;

  function startBuild(modelType) {
    const config = {
      model_type: modelType,
    };

    if (modelType === "arcface") {
      config.model_path = document.getElementById("arcface-model").value;

      const datasetInput = document.getElementById("arcface-dataset-input");
      const dataDir =
        datasetInput.files.length > 0
          ? datasetInput.files[0].webkitRelativePath.split("/")[0]
          : null;

      config.data_dir = dataDir;
      config.output_filename = document.getElementById("arcface-output").value;
      config.device = document.getElementById("arcface-device").value;
      config.use_face_detection = document.getElementById(
        "arcface-face-detection"
      ).checked;

      if (!config.model_path || !config.data_dir) {
        alert("Vui lòng chọn model checkpoint và dataset directory");
        return;
      }
    } else if (modelType === "facenet") {
      config.model_path = document.getElementById("facenet-model").value;

      const datasetInput = document.getElementById("facenet-dataset-input");
      const dataDir =
        datasetInput.files.length > 0
          ? datasetInput.files[0].webkitRelativePath.split("/")[0]
          : null;

      config.data_dir = dataDir;
      config.output_filename = document.getElementById("facenet-output").value;
      config.device = document.getElementById("facenet-device").value;
      config.use_face_detection = document.getElementById(
        "facenet-face-detection"
      ).checked;

      if (!config.model_path || !config.data_dir) {
        alert("Vui lòng chọn model checkpoint và dataset directory");
        return;
      }
    } else if (modelType === "lbph") {
      const datasetInput = document.getElementById("lbph-dataset-input");
      const dataDir =
        datasetInput.files.length > 0
          ? datasetInput.files[0].webkitRelativePath.split("/")[0]
          : null;

      config.data_dir = dataDir;
      config.output_dir = document.getElementById("lbph-output-dir").value;
      config.model_name = document.getElementById("lbph-model-name").value;
      config.target_width = document.getElementById("lbph-width").value;
      config.target_height = document.getElementById("lbph-height").value;
      config.use_face_detection = document.getElementById(
        "lbph-face-detection"
      ).checked;
      config.radius = document.getElementById("lbph-radius").value;
      config.neighbors = document.getElementById("lbph-neighbors").value;
      config.grid_x = document.getElementById("lbph-grid-x").value;
      config.grid_y = document.getElementById("lbph-grid-y").value;
      config.find_threshold = document.getElementById(
        "lbph-find-threshold"
      ).checked;

      if (config.find_threshold) {
        const valInput = document.getElementById("lbph-val-dataset-input");
        const valDir =
          valInput.files.length > 0
            ? valInput.files[0].webkitRelativePath.split("/")[0]
            : null;
        config.val_dir = valDir;

        if (!config.val_dir) {
          alert("Vui lòng chọn validation dataset để tìm threshold");
          return;
        }
      }

      if (!config.data_dir) {
        alert("Vui lòng chọn dataset directory");
        return;
      }
    }

    // Disable buttons
    document.querySelectorAll(".btn").forEach((btn) => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
      btn.style.cursor = "not-allowed";
    });

    fetch("/database-builder/build", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(config),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.error) {
          alert("Lỗi: " + data.error);
          resetButtons();
          return;
        }

        currentJobId = data.job_id;
        document.getElementById("progress-section").classList.add("active");

        // Scroll to progress
        document
          .getElementById("progress-section")
          .scrollIntoView({ behavior: "smooth" });

        // Start polling
        pollInterval = setInterval(pollStatus, 1000);
      })
      .catch((err) => {
        alert("Lỗi: " + err.message);
        resetButtons();
      });
  }

  function pollStatus() {
    if (!currentJobId) return;

    fetch(`/database-builder/status/${currentJobId}`)
      .then((res) => res.json())
      .then((data) => {
        if (data.error) {
          console.error(data.error);
          return;
        }

        updateProgress(data);

        if (data.status === "completed" || data.status === "failed") {
          clearInterval(pollInterval);
          resetButtons();
        }
      })
      .catch((err) => {
        console.error("Poll error:", err);
      });
  }

  function updateProgress(data) {
    document.getElementById("progress-bar").style.width = data.progress + "%";
    document.getElementById("progress-message").textContent = data.message;

    const statusEl = document.getElementById("progress-status");
    statusEl.textContent = data.status.toUpperCase();
    statusEl.className = "progress-status " + data.status;

    // Update logs
    const logContainer = document.getElementById("log-container");
    logContainer.innerHTML = "";
    data.logs.forEach((log) => {
      const line = document.createElement("div");
      line.className = "log-line";
      line.textContent = log;
      logContainer.appendChild(line);
    });
    logContainer.scrollTop = logContainer.scrollHeight;

    // Update output files
    if (Object.keys(data.output_files).length > 0) {
      const filesSection = document.getElementById("output-files");
      filesSection.style.display = "block";

      const filesList = document.getElementById("output-files-list");
      filesList.innerHTML = "";

      Object.entries(data.output_files).forEach(([label, path]) => {
        const fileDiv = document.createElement("div");
        fileDiv.className = "output-file";
        fileDiv.innerHTML = `
          <span><strong>${label}:</strong> ${path}</span>
          <button class="btn-download" onclick="downloadFile('${path}')">
            Download
          </button>
        `;
        filesList.appendChild(fileDiv);
      });
    }
  }

  function downloadFile(path) {
    window.location.href = `/database-builder/download/${path}`;
  }

  function resetButtons() {
    document.querySelectorAll(".btn").forEach((btn) => {
      btn.disabled = false;
      btn.style.opacity = "1";
      btn.style.cursor = "pointer";
    });
  }
</script>

{% endblock %}
