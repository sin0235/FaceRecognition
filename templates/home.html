{% extends "base.html" %} {% block content %}

<div class="card">
  <h2>Nhận dạng</h2>
  <p class="subtitle">
    Upload ảnh để so sánh kết quả của 3 models + Grad-CAM visualization
  </p>

  <form method="POST" enctype="multipart/form-data" id="recognitionForm">
    <div style="margin-bottom: 24px">
      <label style="font-weight: 500; display: block; margin-bottom: 12px">
        Ngưỡng tin cậy (Threshold):
        <b id="v" style="color: var(--primary)"
          >{{ "%.2f"|format(threshold) }}</b
        >
      </label>
      <input
        type="range"
        name="threshold"
        min="0.3"
        max="0.9"
        step="0.05"
        value="{{ threshold }}"
        oninput="v.innerText=parseFloat(this.value).toFixed(2)"
        style="width: 100%; max-width: 400px"
      />
      <span style="font-size: 12px; color: #64748b; margin-left: 10px">
        (Càng cao càng khắt khe)
      </span>
    </div>

    {% if not image_name %}
    <div class="upload-zone" id="uploadZone">
      <div class="upload-zone-content">
        <svg
          style="
            width: 48px;
            height: 48px;
            color: var(--primary);
            margin-bottom: 12px;
          "
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
          ></path>
        </svg>
        <div style="font-weight: 600; font-size: 16px; margin-bottom: 6px">
          Kéo thả ảnh vào đây hoặc
        </div>
        <label for="imageInput" class="upload-label">Chọn ảnh từ máy</label>
        <input
          type="file"
          name="image"
          accept="image/*"
          id="imageInput"
          style="display: none"
          onchange="handleImageSelect(this)"
        />
        <p style="font-size: 12px; color: var(--muted); margin-top: 8px">
          Hỗ trợ: JPG, PNG, JPEG
        </p>
      </div>
    </div>
    {% else %}
    <div style="margin-bottom: 20px">
      <div style="display: flex; gap: 24px; align-items: flex-start">
        <div
          class="preview-box-large"
          onclick="document.getElementById('imageInputChange').click()"
          style="cursor: pointer"
        >
          <img
            id="previewImg"
            src="{{ url_for('static', filename='uploads/' + image_name) }}"
            style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              border-radius: 12px;
            "
          />
        </div>
        <div style="flex: 1">
          <div
            style="font-weight: 600; margin-bottom: 10px; color: var(--text)"
          >
            Ảnh đã chọn
          </div>
          <div
            style="font-size: 13px; color: var(--muted); margin-bottom: 16px"
          >
            {{ image_name }}
          </div>
          <input
            type="file"
            name="image"
            accept="image/*"
            id="imageInputChange"
            style="display: none"
            onchange="handleImageChange(this)"
          />
          <div style="display: flex; gap: 12px; flex-wrap: wrap">
            <button class="btn" type="submit" id="submitBtn">
              <svg
                style="
                  width: 18px;
                  height: 18px;
                  margin-right: 8px;
                  display: inline-block;
                  vertical-align: middle;
                "
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
              Nhận dạng khuôn mặt
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div id="loadingIndicator" style="display: none; margin-top: 20px">
      <div class="loading-spinner" style="margin: 0 auto"></div>
      <p
        style="
          font-size: 13px;
          color: #64748b;
          margin-top: 12px;
          text-align: center;
        "
      >
        Đang xử lý với 3 models...
      </p>
    </div>
  </form>

  <script>
    const uploadZone = document.getElementById('uploadZone');
    const imageInput = document.getElementById('imageInput');
    const form = document.getElementById('recognitionForm');

    if (uploadZone) {
      // Không dùng uploadZone.click để tránh conflict với label
      // Label đã có for="imageInput" nên tự động trigger input

      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          imageInput.files = files;
          form.submit();
        }
      });
    }

    function handleImageSelect(input) {
      if (input.files && input.files[0]) {
        form.submit();
      }
    }

    function handleImageChange(input) {
      if (input.files && input.files[0]) {
        form.submit();
      }
    }

    form.addEventListener('submit', function(e) {
      const fileInput = document.getElementById('imageInput') || document.getElementById('imageInputChange');
      const hasExistingImage = {{ 'true' if image_name else 'false' }};

      if (!fileInput.files.length && !hasExistingImage) {
        e.preventDefault();
        alert('Vui lòng chọn ảnh để nhận dạng!');
        return;
      }

      document.getElementById('loadingIndicator').style.display = 'block';
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.style.display = 'none';
      }
    });
  </script>

  {% if result %}
  <!-- 3 Model Cards -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-top: 28px;
    "
  >
    <!-- ArcFace -->
    <div class="model-card arcface">
      <div style="display: flex; align-items: center; margin-bottom: 12px">
        <div
          style="
            width: 32px;
            height: 32px;
            background: #2563eb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
          "
        >
          <span style="color: white; font-weight: 600; font-size: 12px"
            >AF</span
          >
        </div>
        <div>
          <div style="font-weight: 600; color: #2563eb; font-size: 14px">
            ArcFace
          </div>
          <div style="font-size: 11px; color: #6b7280">
            ResNet50 + Angular Margin
          </div>
        </div>
      </div>

      {% if result.arcface.ok %}
      <span
        style="
          background: #dcfce7;
          color: #16a34a;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Success</span
      >
      {% else %}
      <span
        style="
          background: #fee2e2;
          color: #dc2626;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Error</span
      >
      {% endif %}

      <table style="width: 100%; margin-top: 12px; font-size: 13px">
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Danh tính</td>
          <td style="text-align: right; font-weight: 500">
            {{ result.arcface.detail.identity }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Độ tin cậy</td>
          <td style="text-align: right">
            <span style="font-weight: 600; color: #2563eb"
              >{{ "%.1f"|format(result.arcface.detail.confidence * 100)
              }}%</span
            >
            <span style="color: #94a3b8; font-size: 11px; margin-left: 4px"
              >({{ "%.3f"|format(result.arcface.detail.confidence) }})</span
            >
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Metric</td>
          <td style="text-align: right; color: #64748b; font-size: 12px">
            Cosine Similarity
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Thời gian</td>
          <td style="text-align: right; color: #059669">
            {{ result.arcface.detail.time_ms|default(0) }} ms
          </td>
        </tr>
      </table>

      {% if result.arcface.detail.top_k %}
      <div
        style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid #e5e7eb;
        "
      >
        <div style="font-size: 11px; color: #6b7280; margin-bottom: 6px">
          Top Matches:
        </div>
        {% for item in result.arcface.detail.top_k[:3] %}
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 2px 0;
          "
        >
          <span
            >{{ item[0][:12] }}{% if item[0]|length > 12 %}...{% endif %}</span
          >
          <span style="color: #6b7280">{{ "%.3f"|format(item[1]) }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- FaceNet -->
    <div class="model-card facenet">
      <div style="display: flex; align-items: center; margin-bottom: 12px">
        <div
          style="
            width: 32px;
            height: 32px;
            background: #7c3aed;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
          "
        >
          <span style="color: white; font-weight: 600; font-size: 12px"
            >FN</span
          >
        </div>
        <div>
          <div style="font-weight: 600; color: #7c3aed; font-size: 14px">
            FaceNet
          </div>
          <div style="font-size: 11px; color: #6b7280">
            InceptionResNet + Triplet
          </div>
        </div>
      </div>

      {% if result.facenet.ok %}
      <span
        style="
          background: #dcfce7;
          color: #16a34a;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Success</span
      >
      {% else %}
      <span
        style="
          background: #fee2e2;
          color: #dc2626;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Error</span
      >
      {% endif %}

      <table style="width: 100%; margin-top: 12px; font-size: 13px">
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Danh tính</td>
          <td style="text-align: right; font-weight: 500">
            {{ result.facenet.detail.identity }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Độ tin cậy</td>
          <td style="text-align: right">
            <span style="font-weight: 600; color: #8b5cf6"
              >{{ "%.1f"|format(result.facenet.detail.confidence * 100)
              }}%</span
            >
            <span style="color: #94a3b8; font-size: 11px; margin-left: 4px"
              >({{ "%.3f"|format(result.facenet.detail.confidence) }})</span
            >
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Distance</td>
          <td style="text-align: right; color: #f59e0b; font-size: 12px">
            {{ "%.3f"|format(result.facenet.detail.distance|default(0)) }}
            (Euclidean)
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Thời gian</td>
          <td style="text-align: right; color: #059669">
            {{ result.facenet.detail.time_ms|default(0) }} ms
          </td>
        </tr>
      </table>

      {% if result.facenet.detail.top_k %}
      <div
        style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid #e5e7eb;
        "
      >
        <div style="font-size: 11px; color: #6b7280; margin-bottom: 6px">
          Top Matches:
        </div>
        {% for item in result.facenet.detail.top_k[:3] %}
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 2px 0;
          "
        >
          <span
            >{{ item[0][:12] }}{% if item[0]|length > 12 %}...{% endif %}</span
          >
          <span style="color: #6b7280">{{ "%.3f"|format(item[1]) }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- LBPH -->
    <div class="model-card lbph">
      <div style="display: flex; align-items: center; margin-bottom: 12px">
        <div
          style="
            width: 32px;
            height: 32px;
            background: #059669;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
          "
        >
          <span style="color: white; font-weight: 600; font-size: 12px"
            >LB</span
          >
        </div>
        <div>
          <div style="font-weight: 600; color: #059669; font-size: 14px">
            LBPH
          </div>
          <div style="font-size: 11px; color: #6b7280">
            Local Binary Pattern
          </div>
        </div>
      </div>

      {% if result.lbph.ok %}
      <span
        style="
          background: #dcfce7;
          color: #16a34a;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Success</span
      >
      {% else %}
      <span
        style="
          background: #fee2e2;
          color: #dc2626;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Error</span
      >
      {% endif %}

      <table style="width: 100%; margin-top: 12px; font-size: 13px">
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Danh tính</td>
          <td style="text-align: right; font-weight: 500">
            {{ result.lbph.detail.identity }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Độ tin cậy</td>
          <td style="text-align: right">
            <span style="font-weight: 600; color: #10b981"
              >{{ "%.1f"|format(result.lbph.detail.confidence * 100) }}%</span
            >
            <span style="color: #94a3b8; font-size: 11px; margin-left: 4px"
              >({{ "%.3f"|format(result.lbph.detail.confidence) }})</span
            >
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Distance</td>
          <td style="text-align: right; color: #f59e0b; font-size: 12px">
            {{ "%.2f"|format(result.lbph.detail.distance|default(0)) }}
            (Chi-Square)
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Thời gian</td>
          <td style="text-align: right; color: #059669">
            {{ result.lbph.detail.time_ms|default(0) }} ms
          </td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Chart + Grad-CAM -->
  <div
    style="
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 24px;
    "
  >
    <div class="result-box">
      <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px">
        So sánh hiệu suất
      </div>
      <canvas id="performanceChart" height="180"></canvas>
    </div>

    <div class="result-box">
      <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px">
        Grad-CAM (ArcFace)
      </div>
      {% if gradcam_image %}
      <img
        src="{{ url_for('static', filename=gradcam_image) }}"
        style="width: 100%; max-width: 200px; border-radius: 8px"
      />
      <p style="font-size: 12px; color: #6b7280; margin-top: 8px">
        Vùng màu đỏ = model tập trung khi nhận dạng
      </p>
      {% else %}
      <p style="color: #6b7280; font-size: 13px">Không thể tạo Grad-CAM</p>
      {% endif %}
    </div>
  </div>

  <!-- Face Detection Info -->
  {% set face_info = result.arcface.detail.face_detection %} {% if face_info %}
  <div class="result-box" style="margin-top: 20px">
    <div
      style="
        font-weight: 600;
        margin-bottom: 12px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      "
    >
      <svg
        style="width: 18px; height: 18px; color: #2563eb"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
        ></path>
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
        ></path>
      </svg>
      Thông tin Face Detection
    </div>

    <div
      style="
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      "
    >
      <!-- Số khuôn mặt -->
      <div
        style="
          padding: 12px;
          background: #f8fafc;
          border-radius: 8px;
          border-left: 3px solid #2563eb;
        "
      >
        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px">
          Số khuôn mặt
        </div>
        <div style="font-weight: 600; font-size: 18px; color: #1e293b">
          {{ face_info.num_faces }}
        </div>
        {% if face_info.num_faces == 0 %}
        <div style="font-size: 11px; color: #dc2626; margin-top: 4px">
          Không phát hiện khuôn mặt
        </div>
        {% elif face_info.num_faces > 1 %}
        <div style="font-size: 11px; color: #f59e0b; margin-top: 4px">
          Chỉ nhận dạng khuôn mặt lớn nhất
        </div>
        {% endif %}
      </div>

      <!-- Detection Confidence -->
      {% if face_info.num_faces > 0 %}
      <div
        style="
          padding: 12px;
          background: #f8fafc;
          border-radius: 8px;
          border-left: 3px solid #059669;
        "
      >
        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px">
          Confidence
        </div>
        <div style="font-weight: 600; font-size: 18px; color: #1e293b">
          {{ "%.1f"|format(face_info.confidence * 100) }}%
        </div>
        <div style="font-size: 11px; color: #64748b; margin-top: 4px">
          {{ "%.4f"|format(face_info.confidence) }}
        </div>
      </div>

      <!-- Face Size -->
      {% if face_info.face_size %}
      <div
        style="
          padding: 12px;
          background: #f8fafc;
          border-radius: 8px;
          border-left: 3px solid #7c3aed;
        "
      >
        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px">
          Kích thước khuôn mặt
        </div>
        <div style="font-weight: 600; font-size: 16px; color: #1e293b">
          {{ face_info.face_size[0] }} × {{ face_info.face_size[1] }}
        </div>
        <div style="font-size: 11px; color: #64748b; margin-top: 4px">
          pixels (W × H)
        </div>
      </div>
      {% endif %}

      <!-- Bounding Box -->
      {% if face_info.bbox %}
      <div
        style="
          padding: 12px;
          background: #f8fafc;
          border-radius: 8px;
          border-left: 3px solid #f59e0b;
        "
      >
        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px">
          Bounding Box
        </div>
        <div
          style="
            font-size: 11px;
            color: #1e293b;
            font-family: monospace;
            line-height: 1.5;
          "
        >
          x1: {{ face_info.bbox[0] }}, y1: {{ face_info.bbox[1] }}<br />
          x2: {{ face_info.bbox[2] }}, y2: {{ face_info.bbox[3] }}
        </div>
      </div>
      {% endif %} {% endif %}
    </div>

    <!-- Landmarks -->
    {% if face_info.landmarks and face_info.num_faces > 0 %}
    <div
      style="
        margin-top: 16px;
        padding: 12px;
        background: #fefce8;
        border-radius: 8px;
        border: 1px solid #fde047;
      "
    >
      <div
        style="
          font-size: 12px;
          font-weight: 600;
          color: #854d0e;
          margin-bottom: 8px;
        "
      >
        Facial Landmarks
      </div>
      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
          gap: 8px;
          font-size: 11px;
        "
      >
        <div>
          <span style="color: #64748b">Mắt trái:</span>
          <span style="font-family: monospace; color: #1e293b">
            ({{ "%.0f"|format(face_info.landmarks.left_eye[0]) }}, {{
            "%.0f"|format(face_info.landmarks.left_eye[1]) }})
          </span>
        </div>
        <div>
          <span style="color: #64748b">Mắt phải:</span>
          <span style="font-family: monospace; color: #1e293b">
            ({{ "%.0f"|format(face_info.landmarks.right_eye[0]) }}, {{
            "%.0f"|format(face_info.landmarks.right_eye[1]) }})
          </span>
        </div>
        <div>
          <span style="color: #64748b">Mũi:</span>
          <span style="font-family: monospace; color: #1e293b">
            ({{ "%.0f"|format(face_info.landmarks.nose[0]) }}, {{
            "%.0f"|format(face_info.landmarks.nose[1]) }})
          </span>
        </div>
        <div>
          <span style="color: #64748b">Miệng trái:</span>
          <span style="font-family: monospace; color: #1e293b">
            ({{ "%.0f"|format(face_info.landmarks.left_mouth[0]) }}, {{
            "%.0f"|format(face_info.landmarks.left_mouth[1]) }})
          </span>
        </div>
        <div>
          <span style="color: #64748b">Miệng phải:</span>
          <span style="font-family: monospace; color: #1e293b">
            ({{ "%.0f"|format(face_info.landmarks.right_mouth[0]) }}, {{
            "%.0f"|format(face_info.landmarks.right_mouth[1]) }})
          </span>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Hiển thị ảnh với bounding box -->
    {% if face_info.bbox_image and face_info.num_faces > 0 %}
    <div style="margin-top: 20px; text-align: center">
      <div
        style="
          font-size: 12px;
          font-weight: 600;
          color: #64748b;
          margin-bottom: 12px;
        "
      >
        Ảnh gốc với vùng khuôn mặt được phát hiện
      </div>
      <img
        src="{{ url_for('static', filename=face_info.bbox_image) }}"
        style="
          max-width: 100%;
          height: auto;
          border-radius: 12px;
          border: 2px solid #10b981;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        "
      />
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Summary Table -->
  <div class="result-box" style="margin-top: 20px">
    <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px">
      Bảng tổng hợp
    </div>
    <table style="width: 100%; border-collapse: collapse; font-size: 13px">
      <thead>
        <tr style="background: #f8fafc">
          <th
            style="
              padding: 10px;
              text-align: left;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Model
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Danh tính
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Confidence
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Distance
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Thời gian
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Trạng thái
          </th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom: 1px solid #f1f5f9">
          <td style="padding: 10px"><b style="color: #2563eb">ArcFace</b></td>
          <td style="padding: 10px; text-align: center">
            {{ result.arcface.detail.identity }}
          </td>
          <td style="padding: 10px; text-align: center">
            <span style="font-weight: 600; color: #2563eb"
              >{{ "%.1f"|format(result.arcface.detail.confidence * 100)
              }}%</span
            >
            <span style="color: #94a3b8; font-size: 11px; display: block"
              >({{ "%.3f"|format(result.arcface.detail.confidence) }})</span
            >
          </td>
          <td style="padding: 10px; text-align: center; color: #6b7280">-</td>
          <td style="padding: 10px; text-align: center">
            {{ result.arcface.detail.time_ms|default(0) }}ms
          </td>
          <td style="padding: 10px; text-align: center">
            {% if result.arcface.ok %}<span style="color: #16a34a">OK</span>{%
            else %}<span style="color: #dc2626">Err</span>{% endif %}
          </td>
        </tr>
        <tr style="border-bottom: 1px solid #f1f5f9">
          <td style="padding: 10px"><b style="color: #7c3aed">FaceNet</b></td>
          <td style="padding: 10px; text-align: center">
            {{ result.facenet.detail.identity }}
          </td>
          <td style="padding: 10px; text-align: center">
            <span style="font-weight: 600; color: #8b5cf6"
              >{{ "%.1f"|format(result.facenet.detail.confidence * 100)
              }}%</span
            >
            <span style="color: #94a3b8; font-size: 11px; display: block"
              >({{ "%.3f"|format(result.facenet.detail.confidence) }})</span
            >
          </td>
          <td style="padding: 10px; text-align: center; color: #f59e0b">
            {{ "%.3f"|format(result.facenet.detail.distance|default(0)) }}
          </td>
          <td style="padding: 10px; text-align: center">
            {{ result.facenet.detail.time_ms|default(0) }}ms
          </td>
          <td style="padding: 10px; text-align: center">
            {% if result.facenet.ok %}<span style="color: #16a34a">OK</span>{%
            else %}<span style="color: #dc2626">Err</span>{% endif %}
          </td>
        </tr>
        <tr>
          <td style="padding: 10px"><b style="color: #059669">LBPH</b></td>
          <td style="padding: 10px; text-align: center">
            {{ result.lbph.detail.identity }}
          </td>
          <td style="padding: 10px; text-align: center">
            <span style="font-weight: 600; color: #10b981"
              >{{ "%.1f"|format(result.lbph.detail.confidence * 100) }}%</span
            >
            <span style="color: #94a3b8; font-size: 11px; display: block"
              >({{ "%.3f"|format(result.lbph.detail.confidence) }})</span
            >
          </td>
          <td style="padding: 10px; text-align: center; color: #f59e0b">
            {{ "%.2f"|format(result.lbph.detail.distance|default(0)) }}
          </td>
          <td style="padding: 10px; text-align: center">
            {{ result.lbph.detail.time_ms|default(0) }}ms
          </td>
          <td style="padding: 10px; text-align: center">
            {% if result.lbph.ok %}<span style="color: #16a34a">OK</span>{% else
            %}<span style="color: #dc2626">Err</span>{% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const ctx = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Confidence (%)', 'Thời gian (ms/10)'],
        datasets: [
          {
            label: 'ArcFace',
            data: [{{ (result.arcface.detail.confidence * 100)|round(1) }}, {{ (result.arcface.detail.time_ms|default(0)) / 10 }}],
            backgroundColor: '#2563eb'
          },
          {
            label: 'FaceNet',
            data: [{{ (result.facenet.detail.confidence * 100)|round(1) }}, {{ (result.facenet.detail.time_ms|default(0)) / 10 }}],
            backgroundColor: '#7c3aed'
          },
          {
            label: 'LBPH',
            data: [{{ (result.lbph.detail.confidence * 100)|round(1) }}, {{ (result.lbph.detail.time_ms|default(0)) / 10 }}],
            backgroundColor: '#059669'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });
  </script>
  {% endif %}
</div>

{% endblock %}
