{% extends "base.html" %} {% block content %}

<div class="card">
  <h2>Nhan dang khuon mat</h2>
  <p class="subtitle">
    Upload anh de so sanh ket qua cua 3 models + Grad-CAM visualization
  </p>

  <form method="POST" enctype="multipart/form-data">
    <div style="margin-bottom: 18px">
      <label>Threshold: <b id="v">{{ threshold }}</b></label>
      <input
        type="range"
        name="threshold"
        min="0.3"
        max="0.9"
        step="0.05"
        value="{{ threshold }}"
        oninput="v.innerText=this.value"
        style="width: 180px; margin-left: 10px"
      />
    </div>

    <div class="upload-row">
      <div class="preview-box">
        {% if image_name %}
        <img src="{{ url_for('static', filename='uploads/' + image_name) }}" />
        {% else %}Preview{% endif %}
      </div>

      <div>
        <input type="file" name="image" accept="image/*" />
        <br /><br />
        <button class="btn">Nhan dang</button>
      </div>
    </div>
  </form>

  {% if result %}
  <!-- 3 Model Cards -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-top: 28px;
    "
  >
    <!-- ArcFace -->
    <div class="model-card arcface">
      <div style="display: flex; align-items: center; margin-bottom: 12px">
        <div
          style="
            width: 32px;
            height: 32px;
            background: #2563eb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
          "
        >
          <span style="color: white; font-weight: 600; font-size: 12px"
            >AF</span
          >
        </div>
        <div>
          <div style="font-weight: 600; color: #2563eb; font-size: 14px">
            ArcFace
          </div>
          <div style="font-size: 11px; color: #6b7280">
            ResNet50 + Angular Margin
          </div>
        </div>
      </div>

      {% if result.arcface.ok %}
      <span
        style="
          background: #dcfce7;
          color: #16a34a;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Success</span
      >
      {% else %}
      <span
        style="
          background: #fee2e2;
          color: #dc2626;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Error</span
      >
      {% endif %}

      <table style="width: 100%; margin-top: 12px; font-size: 13px">
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Danh tinh</td>
          <td style="text-align: right; font-weight: 500">
            {{ result.arcface.detail.identity }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Confidence</td>
          <td style="text-align: right">
            {{ "%.3f"|format(result.arcface.detail.confidence) }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Thoi gian</td>
          <td style="text-align: right; color: #059669">
            {{ result.arcface.detail.time_ms|default(0) }} ms
          </td>
        </tr>
      </table>

      {% if result.arcface.detail.top_k %}
      <div
        style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid #e5e7eb;
        "
      >
        <div style="font-size: 11px; color: #6b7280; margin-bottom: 6px">
          Top Matches:
        </div>
        {% for item in result.arcface.detail.top_k[:3] %}
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 2px 0;
          "
        >
          <span
            >{{ item[0][:12] }}{% if item[0]|length > 12 %}...{% endif %}</span
          >
          <span style="color: #6b7280">{{ "%.3f"|format(item[1]) }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- FaceNet -->
    <div class="model-card facenet">
      <div style="display: flex; align-items: center; margin-bottom: 12px">
        <div
          style="
            width: 32px;
            height: 32px;
            background: #7c3aed;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
          "
        >
          <span style="color: white; font-weight: 600; font-size: 12px"
            >FN</span
          >
        </div>
        <div>
          <div style="font-weight: 600; color: #7c3aed; font-size: 14px">
            FaceNet
          </div>
          <div style="font-size: 11px; color: #6b7280">
            InceptionResNet + Triplet
          </div>
        </div>
      </div>

      {% if result.facenet.ok %}
      <span
        style="
          background: #dcfce7;
          color: #16a34a;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Success</span
      >
      {% else %}
      <span
        style="
          background: #fee2e2;
          color: #dc2626;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Error</span
      >
      {% endif %}

      <table style="width: 100%; margin-top: 12px; font-size: 13px">
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Danh tinh</td>
          <td style="text-align: right; font-weight: 500">
            {{ result.facenet.detail.identity }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Similarity</td>
          <td style="text-align: right">
            {{ "%.3f"|format(result.facenet.detail.confidence) }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Distance</td>
          <td style="text-align: right; color: #f59e0b">
            {{ "%.3f"|format(result.facenet.detail.distance|default(0)) }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Thoi gian</td>
          <td style="text-align: right; color: #059669">
            {{ result.facenet.detail.time_ms|default(0) }} ms
          </td>
        </tr>
      </table>

      {% if result.facenet.detail.top_k %}
      <div
        style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid #e5e7eb;
        "
      >
        <div style="font-size: 11px; color: #6b7280; margin-bottom: 6px">
          Top Matches:
        </div>
        {% for item in result.facenet.detail.top_k[:3] %}
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 2px 0;
          "
        >
          <span
            >{{ item[0][:12] }}{% if item[0]|length > 12 %}...{% endif %}</span
          >
          <span style="color: #6b7280">{{ "%.3f"|format(item[1]) }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- LBPH -->
    <div class="model-card lbph">
      <div style="display: flex; align-items: center; margin-bottom: 12px">
        <div
          style="
            width: 32px;
            height: 32px;
            background: #059669;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
          "
        >
          <span style="color: white; font-weight: 600; font-size: 12px"
            >LB</span
          >
        </div>
        <div>
          <div style="font-weight: 600; color: #059669; font-size: 14px">
            LBPH
          </div>
          <div style="font-size: 11px; color: #6b7280">
            Local Binary Pattern
          </div>
        </div>
      </div>

      {% if result.lbph.ok %}
      <span
        style="
          background: #dcfce7;
          color: #16a34a;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Success</span
      >
      {% else %}
      <span
        style="
          background: #fee2e2;
          color: #dc2626;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
        "
        >Error</span
      >
      {% endif %}

      <table style="width: 100%; margin-top: 12px; font-size: 13px">
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Danh tinh</td>
          <td style="text-align: right; font-weight: 500">
            {{ result.lbph.detail.identity }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Confidence</td>
          <td style="text-align: right">
            {{ "%.3f"|format(result.lbph.detail.confidence) }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Distance</td>
          <td style="text-align: right; color: #f59e0b">
            {{ "%.2f"|format(result.lbph.detail.distance|default(0)) }}
          </td>
        </tr>
        <tr>
          <td style="color: #6b7280; padding: 4px 0">Thoi gian</td>
          <td style="text-align: right; color: #059669">
            {{ result.lbph.detail.time_ms|default(0) }} ms
          </td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Chart + Grad-CAM -->
  <div
    style="
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 24px;
    "
  >
    <div class="result-box">
      <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px">
        So sanh hieu suat
      </div>
      <canvas id="performanceChart" height="180"></canvas>
    </div>

    <div class="result-box">
      <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px">
        Grad-CAM (ArcFace)
      </div>
      {% if gradcam_image %}
      <img
        src="{{ url_for('static', filename=gradcam_image) }}"
        style="width: 100%; max-width: 200px; border-radius: 8px"
      />
      <p style="font-size: 12px; color: #6b7280; margin-top: 8px">
        Vung mau do = model tap trung khi nhan dang
      </p>
      {% else %}
      <p style="color: #6b7280; font-size: 13px">Khong the tao Grad-CAM</p>
      {% endif %}
    </div>
  </div>

  <!-- Summary Table -->
  <div class="result-box" style="margin-top: 20px">
    <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px">
      Bang tong hop
    </div>
    <table style="width: 100%; border-collapse: collapse; font-size: 13px">
      <thead>
        <tr style="background: #f8fafc">
          <th
            style="
              padding: 10px;
              text-align: left;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Model
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Danh tinh
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Confidence
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Distance
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Thoi gian
          </th>
          <th
            style="
              padding: 10px;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
            "
          >
            Trang thai
          </th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom: 1px solid #f1f5f9">
          <td style="padding: 10px"><b style="color: #2563eb">ArcFace</b></td>
          <td style="padding: 10px; text-align: center">
            {{ result.arcface.detail.identity }}
          </td>
          <td style="padding: 10px; text-align: center">
            {{ "%.3f"|format(result.arcface.detail.confidence) }}
          </td>
          <td style="padding: 10px; text-align: center; color: #6b7280">-</td>
          <td style="padding: 10px; text-align: center">
            {{ result.arcface.detail.time_ms|default(0) }}ms
          </td>
          <td style="padding: 10px; text-align: center">
            {% if result.arcface.ok %}<span style="color: #16a34a">OK</span>{%
            else %}<span style="color: #dc2626">Err</span>{% endif %}
          </td>
        </tr>
        <tr style="border-bottom: 1px solid #f1f5f9">
          <td style="padding: 10px"><b style="color: #7c3aed">FaceNet</b></td>
          <td style="padding: 10px; text-align: center">
            {{ result.facenet.detail.identity }}
          </td>
          <td style="padding: 10px; text-align: center">
            {{ "%.3f"|format(result.facenet.detail.confidence) }}
          </td>
          <td style="padding: 10px; text-align: center; color: #f59e0b">
            {{ "%.3f"|format(result.facenet.detail.distance|default(0)) }}
          </td>
          <td style="padding: 10px; text-align: center">
            {{ result.facenet.detail.time_ms|default(0) }}ms
          </td>
          <td style="padding: 10px; text-align: center">
            {% if result.facenet.ok %}<span style="color: #16a34a">OK</span>{%
            else %}<span style="color: #dc2626">Err</span>{% endif %}
          </td>
        </tr>
        <tr>
          <td style="padding: 10px"><b style="color: #059669">LBPH</b></td>
          <td style="padding: 10px; text-align: center">
            {{ result.lbph.detail.identity }}
          </td>
          <td style="padding: 10px; text-align: center">
            {{ "%.3f"|format(result.lbph.detail.confidence) }}
          </td>
          <td style="padding: 10px; text-align: center; color: #f59e0b">
            {{ "%.2f"|format(result.lbph.detail.distance|default(0)) }}
          </td>
          <td style="padding: 10px; text-align: center">
            {{ result.lbph.detail.time_ms|default(0) }}ms
          </td>
          <td style="padding: 10px; text-align: center">
            {% if result.lbph.ok %}<span style="color: #16a34a">OK</span>{% else
            %}<span style="color: #dc2626">Err</span>{% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const ctx = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Confidence (%)', 'Thoi gian (ms/10)'],
        datasets: [
          {
            label: 'ArcFace',
            data: [{{ (result.arcface.detail.confidence * 100)|round(1) }}, {{ (result.arcface.detail.time_ms|default(0)) / 10 }}],
            backgroundColor: '#2563eb'
          },
          {
            label: 'FaceNet',
            data: [{{ (result.facenet.detail.confidence * 100)|round(1) }}, {{ (result.facenet.detail.time_ms|default(0)) / 10 }}],
            backgroundColor: '#7c3aed'
          },
          {
            label: 'LBPH',
            data: [{{ (result.lbph.detail.confidence * 100)|round(1) }}, {{ (result.lbph.detail.time_ms|default(0)) / 10 }}],
            backgroundColor: '#059669'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });
  </script>
  {% endif %}
</div>

{% endblock %}
