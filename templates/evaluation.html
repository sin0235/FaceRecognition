{%extends "base.html" %} {% block content %}

<div class="card animate">
  <h2>Đánh giá Models</h2>

  <!-- Tabs -->
  <div
    style="
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #eee;
      padding-bottom: 15px;
    "
  >
    <a
      href="/evaluation?mode=kaggle"
      class="btn"
      style="{% if mode == 'kaggle' %}background:#2563eb{% else %}background:#94a3b8{% endif %}"
    >
      Kết quả từ Kaggle
    </a>
    <a
      href="/evaluation?mode=demo"
      class="btn"
      style="{% if mode == 'demo' %}background:#2563eb{% else %}background:#94a3b8{% endif %}"
    >
      Demo từ Test Set
    </a>
  </div>

  {% if mode == 'kaggle' %}
  <!-- Kaggle content giữ nguyên như file cũ -->
  <p class="subtitle">
    Kết quả đánh giá trên Kaggle (notebook: evaluate_arcface.ipynb)
  </p>

  <!-- Accuracy Cards -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    "
  >
    <div
      style="
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
      "
    >
      <h3 style="opacity: 0.9">ArcFace</h3>
      <div style="font-size: 2em; font-weight: 700; margin: 10px 0">
        {{ metrics.arcface.accuracy }}%
      </div>
      <small>Top-1 Accuracy</small>
      <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.85">
        Top-5: {{ metrics.arcface.top5_accuracy }}%
      </div>
    </div>
    <div
      style="
        background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
        color: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
      "
    >
      <h3 style="opacity: 0.9">FaceNet</h3>
      <div style="font-size: 2em; font-weight: 700; margin: 10px 0">
        {{ metrics.facenet.accuracy }}%
      </div>
      <small>Top-1 Accuracy</small>
      <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.85">
        Top-5: {{ metrics.facenet.top5_accuracy }}%
      </div>
    </div>
    <div
      style="
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
      "
    >
      <h3 style="opacity: 0.9">LBPH</h3>
      <div style="font-size: 2em; font-weight: 700; margin: 10px 0">
        {{ metrics.lbph.accuracy }}%
      </div>
      <small>Top-1 Accuracy</small>
      <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.85">
        Top-5: {{ metrics.lbph.top5_accuracy }}%
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div
    style="
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 40px;
    "
  >
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px">
      <h3 style="margin-bottom: 15px; text-align: center">
        Accuracy Comparison
      </h3>
      <canvas id="accuracyChart" height="200"></canvas>
    </div>
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px">
      <h3 style="margin-bottom: 15px; text-align: center">
        Classification Metrics
      </h3>
      <canvas id="metricsChart" height="200"></canvas>
    </div>
  </div>

  <div
    style="
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    "
  >
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px">
      <h3 style="margin-bottom: 15px; text-align: center">AUC-ROC & EER</h3>
      <canvas id="aucChart" height="200"></canvas>
    </div>
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px">
      <h3 style="margin-bottom: 15px; text-align: center">
        Performance (Speed)
      </h3>
      <canvas id="performanceChart" height="200"></canvas>
    </div>
  </div>

  <!-- Kaggle JS charts -->
  <script>
    new Chart(document.getElementById('accuracyChart'), {
      type: 'bar',
      data: {
        labels: ['ArcFace', 'FaceNet', 'LBPH'],
        datasets: [{
          label: 'Top-1 Accuracy',
          data: [{{ metrics.arcface.accuracy }}, {{ metrics.facenet.accuracy }}, {{ metrics.lbph.accuracy }}],
          backgroundColor: ['#2563eb', '#7c3aed', '#059669'],
          borderRadius: 8
        }, {
          label: 'Top-5 Accuracy',
          data: [{{ metrics.arcface.top5_accuracy }}, {{ metrics.facenet.top5_accuracy }}, {{ metrics.lbph.top5_accuracy }}],
          backgroundColor: ['#93c5fd', '#c4b5fd', '#6ee7b7'],
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, max: 100 } },
        plugins: { legend: { position: 'bottom' } }
      }
    });

    new Chart(document.getElementById('metricsChart'), {
      type: 'radar',
      data: {
        labels: ['Precision', 'Recall', 'F1-Score'],
        datasets: [{
          label: 'ArcFace',
          data: [{{ metrics.arcface.precision * 100 }}, {{ metrics.arcface.recall * 100 }}, {{ metrics.arcface.f1 * 100 }}],
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.2)'
        }, {
          label: 'FaceNet',
          data: [{{ metrics.facenet.precision * 100 }}, {{ metrics.facenet.recall * 100 }}, {{ metrics.facenet.f1 * 100 }}],
          borderColor: '#7c3aed',
          backgroundColor: 'rgba(124, 58, 237, 0.2)'
        }, {
          label: 'LBPH',
          data: [{{ metrics.lbph.precision * 100 }}, {{ metrics.lbph.recall * 100 }}, {{ metrics.lbph.f1 * 100 }}],
          borderColor: '#059669',
          backgroundColor: 'rgba(5, 150, 105, 0.2)'
        }]
      },
      options: {
        responsive: true,
        scales: { r: { beginAtZero: true, max: 100 } },
        plugins: { legend: { position: 'bottom' } }
      }
    });

    new Chart(document.getElementById('aucChart'), {
      type: 'bar',
      data: {
        labels: ['ArcFace', 'FaceNet', 'LBPH'],
        datasets: [{
          label: 'AUC (x100)',
          data: [{{ metrics.arcface.auc * 100 }}, {{ metrics.facenet.auc * 100 }}, {{ metrics.lbph.auc * 100 }}],
          backgroundColor: ['#2563eb', '#7c3aed', '#059669'],
          borderRadius: 8
        }, {
          label: 'EER (x100, lower is better)',
          data: [{{ metrics.arcface.eer * 100 }}, {{ metrics.facenet.eer * 100 }}, {{ metrics.lbph.eer * 100 }}],
          backgroundColor: ['#ef4444', '#f97316', '#eab308'],
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { position: 'bottom' } }
      }
    });

    new Chart(document.getElementById('performanceChart'), {
      type: 'bar',
      data: {
        labels: ['ArcFace', 'FaceNet', 'LBPH'],
        datasets: [{
          label: 'Throughput (img/s)',
          data: [{{ metrics.arcface.throughput }}, {{ metrics.facenet.throughput }}, {{ metrics.lbph.throughput }}],
          backgroundColor: ['#2563eb', '#7c3aed', '#059669'],
          borderRadius: 8,
          yAxisID: 'y'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Throughput (img/s)' } }
        }
      }
    });
  </script>

  {% else %}
  <!-- Demo Mode  -->
  <p class="subtitle">Demo đánh giá trực tiếp trên tập test</p>

  <!-- Form chọn thư mục  -->
  <form
    method="POST"
    action="/evaluation?mode=demo"
    style="margin-bottom: 30px"
  >
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px">
      <div style="margin-bottom: 15px">
        <label style="font-weight: 600; display: block; margin-bottom: 8px"
          >Thư mục Test:</label
        >
        <input
          type="text"
          name="test_folder"
          placeholder="Để trống = mặc định ({{ info.aligned.classes }} classes)"
          style="
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
          "
        />
        <small style="color: #64748b"
          >Mặc định: data/CelebA_Aligned/test/images_aligned</small
        >
      </div>

      <div style="margin-bottom: 15px">
        <label style="font-weight: 600; display: block; margin-bottom: 8px"
          >Số ảnh mỗi class:</label
        >
        <input
          type="number"
          name="max_images"
          value="5"
          min="1"
          max="20"
          style="
            width: 150px;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
          "
        />
        <small style="color: #64748b">Giới hạn để tránh quá lâu</small>
      </div>

      <button class="btn" type="submit">Chạy Evaluation</button>
    </div>
  </form>

  {% if demo_results %} {% if demo_results.error %}
  <div
    style="
      background: #fef2f2;
      color: #dc2626;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #dc2626;
    "
  >
    {{ demo_results.error }}
  </div>
  {% else %}
  <!-- Metrics Cards -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    "
  >
    <div
      style="
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      "
    >
      <div style="font-size: 2.5em; font-weight: 700">
        {{ "%.1f"|format(demo_results.accuracy) }}%
      </div>
      <small style="opacity: 0.9">Accuracy</small>
    </div>
    <div
      style="
        background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      "
    >
      <div style="font-size: 2.5em; font-weight: 700">
        {{ "%.1f"|format(demo_results.precision) }}%
      </div>
      <small style="opacity: 0.9">Precision</small>
    </div>
    <div
      style="
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      "
    >
      <div style="font-size: 2.5em; font-weight: 700">
        {{ "%.1f"|format(demo_results.recall) }}%
      </div>
      <small style="opacity: 0.9">Recall</small>
    </div>
    <div
      style="
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      "
    >
      <div style="font-size: 2.5em; font-weight: 700">
        {{ "%.1f"|format(demo_results.f1) }}%
      </div>
      <small style="opacity: 0.9">F1-Score</small>
    </div>
  </div>

  <!-- Confusion Matrix -->
  <div
    style="
      background: #f8fafc;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
    "
  >
    <h3 style="margin-bottom: 20px; text-align: center">Confusion Matrix</h3>
    <div style="overflow-x: auto">
      <table style="margin: 0 auto; border-collapse: collapse; font-size: 12px">
        <thead>
          <tr>
            <th
              style="
                padding: 8px;
                border: 1px solid #e2e8f0;
                background: #f8fafc;
              "
            ></th>
            {% for cls in demo_results.classes %}
            <th
              style="
                padding: 8px;
                border: 1px solid #e2e8f0;
                background: #f8fafc;
                writing-mode: vertical-rl;
                transform: rotate(180deg);
              "
            >
              {{ cls[:10] }}
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for i, true_cls in enumerate(demo_results.classes) %}
          <tr>
            <th
              style="
                padding: 8px;
                border: 1px solid #e2e8f0;
                background: #f8fafc;
                text-align: left;
              "
            >
              {{ true_cls[:10] }}
            </th>
            {% for j, pred_cls in enumerate(demo_results.classes) %} {% set
            count = demo_results.confusion_matrix[i][j] %} {% set is_diagonal =
            (i == j) %}
            <td
              style="padding: 8px; border: 1px solid #e2e8f0; text-align: center; 
                      background: {% if count > 0 %}{% if is_diagonal %}#dcfce7{% else %}#fee2e2{% endif %}{% else %}white{% endif%};
                      font-weight: {% if count > 0 %}600{% else %}normal{% endif %};"
            >
              {{ count if count > 0 else '' }}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div
      style="
        margin-top: 15px;
        text-align: center;
        font-size: 12px;
        color: #64748b;
      "
    >
      <span style="display: inline-block; margin: 0 10px"
        ><span
          style="
            display: inline-block;
            width: 15px;
            height: 15px;
            background: #dcfce7;
            border: 1px solid #059669;
            vertical-align: middle;
          "
        ></span>
        Correct</span
      >
      <span style="display: inline-block; margin: 0 10px"
        ><span
          style="
            display: inline-block;
            width: 15px;
            height: 15px;
            background: #fee2e2;
            border: 1px solid #dc2626;
            vertical-align: middle;
          "
        ></span>
        Incorrect</span
      >
    </div>
  </div>

  <!-- Results Summary -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    "
  >
    <div
      style="
        background: #dcfce7;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      "
    >
      <div style="font-size: 1.8em; font-weight: 700; color: #16a34a">
        {{ demo_results.correct }}
      </div>
      <small>Correct</small>
    </div>
    <div
      style="
        background: #fee2e2;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      "
    >
      <div style="font-size: 1.8em; font-weight: 700; color: #dc2626">
        {{ demo_results.wrong }}
      </div>
      <small>Wrong</small>
    </div>
    <div
      style="
        background: #dbeafe;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      "
    >
      <div style="font-size: 1.8em; font-weight: 700; color: #2563eb">
        {{ demo_results.total }}
      </div>
      <small>Total</small>
    </div>
  </div>

  <!-- Sample Results Table -->
  <div style="background: #f8fafc; padding: 20px; border-radius: 12px">
    <h3 style="margin-bottom: 15px">
      Chi tiết nhận dạng ({{ demo_results.samples|length }} mẫu)
    </h3>
    <div style="max-height: 400px; overflow-y: auto">
      <table style="width: 100%; border-collapse: collapse; font-size: 0.9em">
        <thead style="position: sticky; top: 0; background: white">
          <tr style="background: #f3f4f6">
            <th style="padding: 10px; text-align: left">Image</th>
            <th style="padding: 10px; text-align: left">True</th>
            <th style="padding: 10px; text-align: left">Predicted</th>
            <th style="padding: 10px; text-align: center">Confidence</th>
            <th style="padding: 10px; text-align: center">✓</th>
          </tr>
        </thead>
        <tbody>
          {% for s in demo_results.samples %}
          <tr
            style="border-bottom:1px solid #eee; background:{% if s.correct %}#f0fdf4{% else %}#fef2f2{% endif %}"
          >
            <td style="padding: 8px">{{ s.image[:25] }}...</td>
            <td style="padding: 8px">{{ s.true_label }}</td>
            <td style="padding: 8px">{{ s.predicted }}</td>
            <td style="padding: 8px; text-align: center">
              {{ "%.2f"|format(s.confidence) }}
            </td>
            <td style="padding: 8px; text-align: center">
              {% if s.correct %}<span style="color: #16a34a; font-size: 1.2em"
                >✓</span
              >
              {% else %}<span style="color: #dc2626; font-size: 1.2em">✗</span
              >{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %} {% endif %} {% endif %}
</div>

{% endblock %}
